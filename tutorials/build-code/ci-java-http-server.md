---
sidebar_position: 3
description: This build automation guide walks you through building and testing a Java HTTP server application in a CI Pipeline
keywords: [Hosted Build, Continuous Integration, Hosted, CI Tutorial]
---

# Build, test, and publish a Docker Image for a Java HTTP server application

In this tutorial, you will build, test, and publish a Docker image for a Java HTTP server application, and then run a connectivity test using the published image.

:::tip

For a comprehensive guide on application testing, Harness provides O'Reilly's **Full Stack Testing** book for free at https://harness.io/resources/oreilly-full-stack-testing.

:::

## Create your pipeline

```mdx-code-block
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
```

1. Fork the repository https://github.com/keen-software/jhttp into your GitHub account.
2. Follow the **Get Started** wizard in Harness CI.
   ```mdx-code-block
   <Tabs>
     <TabItem value="newaccount" label="New account" default>
       If are signing in to Harness for the first time, select the <strong>Continuous Integration</strong> module after your initial login. This will bring you into the <strong>Get Started</strong> wizard.
     </TabItem>
     <TabItem value="existingaccount" label="Existing Account">
       If you have an existing Harness account, either create a new Project, or select an existing Project. Select the <strong>Continuous Integration</strong> module, expand the <strong>Project Setup</strong> menu on the left, then click <strong>Get Started</strong>.
     </TabItem>
   </Tabs>
   ```
3. When prompted to select a repository, search for "jhttp", select the repository that you forked in the earlier step, then click **Configure Pipeline**. 
4. Click **Starter Pipeline**, then click **Create Pipeline**.
5. You should now see the **Execution** tab of your pipeline.

### Add Run Tests Step

This step will run the application's unit tests.

1. Click **Add Step**, the **Step Library** dialogue window will appear. Select **Run Tests** from the list.
2. Select **Java** from the **Language** drop-down menu.
3. Select **Maven** from the **Build Tool** drop-down menu.
4. Enter `test` in the **Build Arguments** field.
5. Enter `io.harness.` in the **Packages** field.
6. Click **+ Add** under **Test Report Paths** and enter `**/*.xml` in the provided field.
   
   :::info

   `**/*.xml` will find all JUnit XML formatted files that are generated by the tests.

   :::

7. Enter `mvn package -DskipTests` in the **Post-Command** field.
8. Expand the **Additional Configuration** section, click the **Container Registry** field and either select an existing [Docker Hub](https://hub.docker.com/) connector, or create one.
9. Enter `maven:3.5.2-jdk-8-alpine` in the **Image** field.
10. Ensure that **Run only selected tests** is selected.
11. Enter `30m` in the **Timeout** field.
12. Click **Apply Changes**.

### Add Docker Build and Publish Step

This step will package the application as a Docker image and publish the image to Docker Hub.

1. Click **Add Step**, the **Step Library** dialogue window will appear. Select **Build and Push an image to Docker Registry** from the list.
2. Click the **Docker Connector** field and either select an existing [Docker Hub](https://hub.docker.com/) connector, or create one.

   :::tip

   Since your pipeline will publish the image to your Docker Hub account, your connector will need an access token with **Read, Write, Delete** permissions.

   :::
3. Enter `your_user/jhttp` (replace `your_user` with your Docker Hub username) in the **Docker Repository** field.
4. Click **+ Add** under **Tags**, a field will appear.

   Click the icon on the right side of the field and select **Expression**.
   
   Start to type `<+pipeline.` in the field, you will see suggestions for all available expressions. Select `sequenceId`. The field should now contain `<+pipeline.sequenceId>`.

   :::info

   `<+pipeline.sequenceId>` is a value provided at pipeline execution time. This value matches the pipeline sequence number, which is unique to each pipeline execution.

   This ensures that the resulting Docker image will always have a unique tag.

   :::
5. Click **Apply Changes**.

### Add Integration Tests Stage

This separate pipeline stage will pull the Docker image published in the previous step, run it as a [Background step](../../docs/continuous-integration/ci-technical-reference/background-step-settings.md), and verify the container started successfully.

1. In the **Pipeline Studio** click **Add Stage** and select **Build**.

   Enter `Run Connectivity Test` in the **Stage Name** field, then click **Set Up Stage**.

   :::tip performance tip

   The steps in this stage do not require code from the Git repository. To save time in each pipeline execution, disable **Clone Codebase**.

   :::

2. In the **Infrastructure** tab, select **Propagate from an existing stage**, select the previous stage from the drop-down menu and click **Continue**.

### Add Background Step

This Background step runs the Docker image published in the previous stage.

1. Click **Add Step**, the **Step Library** dialogue window will appear. Select **Background** from the list.
2. Enter `Run Java HTTP Server` in the **Name** field.
3. Expand the **Additional Configuration** section, click the **Container Registry** field and select your Docker Hub connector.
4. Enter `your_user/jhttp:<+pipeline.sequenceId>` (replace `your_user` with your Docker Hub username) in the **Image** field.
5. Click **+ Add** under **Port Bindings**, enter `8888` in the **Host Port** and **Container Port** fields.

   :::info

   This will expose port `8888` from the running container to the host operating system. This will allow the connection test step to reach the application at `localhost:8888`.

   :::

6. Click **Apply Changes**.

### Add Connection Test Step

This step runs a connection test from the host operating system, verifying the application started successfully.

1. Click **Add Step**, the **Step Library** dialogue window will appear. Select **Run** from the list.
2. Enter `Test Connection to Java HTTP Server` in the **Name** field.
3. Enter this in the **Command** field:
   ```
   until curl --max-time 1 http://localhost:8888; do
     sleep 2;
   done
   ```
   :::info

   This simple connectivity test will attempt to reach the service every two seconds, until successful.

   :::

4. Click **Apply Changes**, then click **Save**.

   :::tip

   With the application up and running, many types of tests are possible: integration, security, performance, and more!

   :::

### Optional YAML Configuration

If you switch from **Visual** to **YAML** in the Pipeline Studio, your pipeline should look similar to this:

<details><summary>Click to expand</summary>
<p>

```yaml
pipeline:
  name: Build jhttp
  identifier: Build_jhttp_XYZ123
  projectIdentifier: Default_Project_XYZ123
  orgIdentifier: default
  stages:
    - stage:
        name: Build
        identifier: Build
        type: CI
        spec:
          cloneCodebase: true
          execution:
            steps:
              - step:
                  type: RunTests
                  name: Run Tests
                  identifier: RunTests
                  spec:
                    connectorRef: docker_hub
                    image: maven:3.5.2-jdk-8-alpine
                    language: Java
                    buildTool: Maven
                    args: test
                    packages: io.harness.
                    runOnlySelectedTests: true
                    postCommand: mvn package -DskipTests
                    reports:
                      type: JUnit
                      spec:
                        paths:
                          - "**/*.xml"
                  timeout: 30m
              - step:
                  type: BuildAndPushDockerRegistry
                  name: Build and Push an image to Docker Registry
                  identifier: BuildandPushanimagetoDockerRegistry
                  spec:
                    connectorRef: docker_hub
                    repo: your_user/jhttp
                    tags:
                      - <+pipeline.sequenceId>
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
    - stage:
        name: Run Connectivity Test
        identifier: Run_Connectivity_Test
        description: ""
        type: CI
        spec:
          cloneCodebase: false
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - step:
                  type: Background
                  name: Run Java HTTP Server
                  identifier: Run_Java_HTTP_Server
                  spec:
                    connectorRef: docker_hub
                    image: your_user/jhttp:<+pipeline.sequenceId>
                    shell: Sh
                    portBindings:
                      "8888": "8888"
              - step:
                  type: Run
                  name: Test Connection to Java HTTP Server
                  identifier: Test_Connection_to_Java_HTTP_Server
                  spec:
                    shell: Sh
                    command: |-
                      until curl --max-time 1 http://localhost:8888; do
                        sleep 2;
                      done
  properties:
    ci:
      codebase:
        connectorRef: account.Github_OAuth_XYZ123
        repoName: your_user/jhttp
        build: <+input>
```

</p>
</details>

## Run your pipeline

1. In the **Pipeline Studio** click **Run**, the **Run Pipeline** dialogue window will open.
2. Select **Git Branch** as the **Build Type**, and enter `main` in the **Branch Name** field.
3. Click **Run Pipeline**.
4. Observe each step of the pipeline execution. When the first stage completes, test results will appear in the **Tests** tab. When the second stage completes, you should see the successful `curl` command in the final step.