---
sidebar_position: 2
description: Onboard with Terraform Provider
---

# Onboard with Terraform Provider

The [Harness Terraform Provider](https://registry.terraform.io/providers/harness/harness/) enables automated lifecycle management of the Harness Platform using Terraform. Currently the following Harness entities can be managed via the provider.

- Organizations
- Projects
- Connectors
- Services
- Environments
- Infrastructure Definitions
- Pipelines
- Permissions
- Secrets

This tutorial shows you how to manage all the above entities except Permissions and Secrets.

## Prerequisite

### Install terraform CLI

Install the [terraform CLI v1.3.x](https://developer.hashicorp.com/terraform/downloads) on your host machine. Run the following command to verify.
```
terraform -version
```

### Get Your Harness Account ID 

You will also need to provde your Harness accountId as an input parameter to the terraform provider. This accountId is present in every Harness URL. For example, in the following URL

```
https://app.harness.io/ng/#/account/6_vVHzo9Qeu9fXvj-AcQCb/settings/overview
```

`6_vVHzo9Qeu9fXvj-AcQCb` is the accountId. 

### Get Harness API Key Token

Login to your Harness Account and click My Profile on the left navigation. Click +API Key to create a new API key. Now click +Token to create API key token. Give the token a name and save the token that gets autogenerated when you click Apply.  

## Create your main.tf file

You can create your own main.tf file. For this tutorial, we will use a sample main.tf file

```
curl -LO https://raw.githubusercontent.com/harness-apps/developer-hub-apps/main/terraform/main.tf
```

### Specify the harness provider

Open the `main.tf` file in a text editor and replace `PUT_YOUR_HARNESS_ACCOUNTID_HERE` and `PUT_YOUR_API_KEY_TOKEN_HERE` with your Harness accountId and PAT values respectively. 

```
terraform {
  required_providers {
    harness = {
      source = "harness/harness"
    }
  }
}

provider "harness" {
  endpoint         = "https://app.harness.io/gateway"
  account_id       = "PUT_YOUR_HARNESS_ACCOUNTID_HERE"
  platform_api_key = "PUT_YOUR_API_KEY_TOKEN_HERE"
}

...
```

### Create the terraform resources

Review the`main.tf` file for the operations that terraform is going to execute for us. As you can see, the sample first creates a new organization as well as a new project inside that organization. It then creates a helm chart service that will be deployed to Kubernetes infrastructure running in a pre-production environment. A new pipeline is then created to make this service deployment happen. 

At every step, you can use existing organizations, projects, services, environments if you so desire. We will now review the terraform resource definition for each of these entities.

#### Create a new organization
```
resource "harness_platform_organization" "org" {
    name      = "OrgByTF"
    identifier = "orgbytf"
    description = "Created through Terraform"
}
```

#### Create a new project in the organization
```
resource "harness_platform_project" "project" {
    name      = "ProjByTF"
    identifier = "projbytf"
    org_id    = "orgbytf"
    description = "Created through Terraform"
}
```

#### Create a helm connector at account level

Account-level connectors are available to all projects in all organizations. We create such a connector by not setting the org_id and project_id attributes in the terraform resource. We will use this connector to retrieve the Kubernetes manifests for the sample service we will deploy.
```
resource "harness_platform_connector_helm" "helmconn" {
    name      = "HelmConnByTF"
    identifier = "helmconnbytf"
    description = "Created through Terraform"
    yaml            = <<-EOT
        ...
    EOT
}
```

#### Create a service inside the project 

This service will use the above Helm connector to deploy a Helm Chart.
```
resource "harness_platform_service" "service" {
  identifier  = "identifier"
  name        = "name"
  description = "test"
  org_id      = "org_id"
  project_id  = "project_id"
  yaml        = <<-EOT
    ...  
  EOT
}
```

#### Create a kubernetes connector at account level

We will deploy the service defined earlier to the Kubernetes cluster associated with this connector.
```
resource "harness_platform_connector_kubernetes" "k8sconn" {
    name      = "K8SConnByTF"
    identifier = "k8sconnbytf"
    description = "Created through Terraform"
    yaml            = <<-EOT
        ...
    EOT
}
```

#### Create an environment in the project

Create an environment inside the project that refers to the Kubernetes connector we defined in the previous step. Environments can be of `PreProduction` or `Production` types and we will use the former for this example.
```
resource "harness_platform_environment" "env" {
  identifier = "identifier"
  name       = "name"
  org_id     = "orgbytf"
  project_id = "projbytf"
  tags       = []
  type       = "PreProduction"
  yaml       = <<-EOT
    ...   
  EOT
}
```

#### Create a infrastructure definition in the environment

Create a infrastructure definition in the environment we just created.
```
resource "harness_platform_infrastructure" "infra" {
  identifier      = "preprodk8s"
  name            = "preprod-k8s"
  org_id          = "orgbytf"
  project_id      = "projbytf"
  env_id          = "envbytf"
  type            = "KubernetesDirect"
  deployment_type = "Kubernetes"
  yaml            = <<-EOT
    ...
  EOT
}
```

#### Create a pipeline inside the project

Every run of this pipeline will deploy a particular version of the service onto the Kubernetes cluster.
```
resource "harness_platform_pipeline" "pipeline" {
  identifier = "identifier"
  org_id     = "orgIdentifier"
  project_id = "projectIdentifier"
  name       = "name"
  yaml = <<-EOT
    ...     
  EOT
}
```

## Run terraform init, plan and apply

Initialize terraform. This will download the harnes provider onto your machine.
```
terraform init
```

Run the following step to see exactly the changes terraform is going to make on your behaf.
```
terraform plan
```

Finally, run this step to make terraform onboard your entities onto the Harness Platform.
```
terraform apply
```

When prompted by terraform if you want to continue with the apply step, type `yes` and then you will see output similar to the following.

```
harness_platform_connector_kubernetes.k8sconn: Creating...
harness_platform_organization.org: Creating...
harness_platform_connector_helm.helmconn: Creating...
harness_platform_connector_helm.helmconn: Creation complete after 2s [id=helmconnbytf]
harness_platform_organization.org: Creation complete after 2s [id=orgbytf]
harness_platform_connector_kubernetes.k8sconn: Creation complete after 2s [id=k8sconnbytf]
harness_platform_project.project: Creating...
harness_platform_project.project: Creation complete after 2s [id=projbytf]
harness_platform_service.service: Creating...
harness_platform_environment.env: Creating...
harness_platform_environment.env: Creation complete after 1s [id=envbytf]
harness_platform_service.service: Creation complete after 1s [id=servicebytf]
harness_platform_infrastructure.infra: Creating...
harness_platform_infrastructure.infra: Creation complete after 3s [id=infrabytf]
harness_platform_pipeline.pipeline: Creating...
harness_platform_pipeline.pipeline: Creation complete after 5s [id=pipelinebytf]

Apply complete! Resources: 8 added, 0 changed, 0 destroyed.
```

## Verify and run pipeline on Harness UI

On Harness UI, you can go to Account Settings --> Organizations to see the new organization. Click View Projects to see the new project. Click the project and go into the "Continuous Delivery" module. When you click Pipelines now, you can see the new pipeline has been created. You can run this pipeline as long as you have previously installed a delegate with name `firstk8sdel` using the Kubernetes delegate instructions from the [Install Delegate](../install-delegate).

## Run terraform destroy

This is as simple as the command below. 
```
terraform destroy
```
